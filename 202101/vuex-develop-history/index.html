<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>vuex实现历史记录 KwokRonny&#39;Blog</title><meta name="keywords" content="blog,博客"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><link rel="alternate" href="/atom.xml" title="KwokRonny Feed" type="application/atom+xml"><link rel="stylesheet" href="//at.alicdn.com/t/font_2236624_69rc9okdrcb.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="header"><div class="nav-btn"><span class="lt"><i></i></span><span class="lb"><i></i></span></div><a href="/" class="logo">KwokRonny&#39;Blog</a><div class="nav"><div class="nav-item"><a class="hover" href="/archives"><i class="fa fa-archive"></i> 文章</a></div><div class="nav-item"><a href="#" class="hover"><i class="fa fa-inbox"></i> 分类</a><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/"><i class="fa fa-folder-open"></i> JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/"><i class="fa fa-folder-open"></i> docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E6%96%87/"><i class="fa fa-folder-open"></i> 杂文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><i class="fa fa-folder-open"></i> 解决方案</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/WEB%E5%BC%80%E5%8F%91/"><i class="fa fa-folder-open"></i> WEB开发</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/"><i class="fa fa-folder-open"></i> 软件分享</a></li></ul></div><div class="nav-item"><a href="#" class="hover"><i class="fa fa-tag"></i> 标签</a><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag"><i class="fa fa-tag"></i> JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag"><i class="fa fa-tag"></i> Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag"><i class="fa fa-tag"></i> css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag"><i class="fa fa-tag"></i> nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stylus/" rel="tag"><i class="fa fa-tag"></i> stylus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag"><i class="fa fa-tag"></i> web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag"><i class="fa fa-tag"></i> 工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%9D%E8%B7%AF/" rel="tag"><i class="fa fa-tag"></i> 思路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E6%96%87/" rel="tag"><i class="fa fa-tag"></i> 杂文</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/" rel="tag"><i class="fa fa-tag"></i> 软件分享</a></li></ul></div><div class="nav-item"><a class="hover" href="/about"><i class="fa fa-user"></i> 关于</a></div><div class="nav-item"><a href="/friend" class="hover"><i class="fa fa-mars"></i> 小伙伴们</a><div class="friend-link-list clearfix"><a class="friend" target="_blank" href="https://www.mokeyjay.com/"><img src="https://www.mokeyjay.com/headimg.png"><div class="info"><h3 class="text-clamp_1" title="超能小紫 mokeyjay">超能小紫 mokeyjay</h3><div class="text-clamp_1" title="Web全沾 // 专业学渣 // 贰刺猿 // 永远还不完信用卡">Web全沾 // 专业学渣 // 贰刺猿 // 永远还不完信用卡</div></div></a></div></div><div class="nav-item"><a class="hover" target="_blank" rel="noopener" href="https://github.com/kwokronny"><i class="fa fa-github-alt"></i> 开源</a></div><div class="nav-item"><a href="/atom.xml" class="hover"><i class="fa fa-rss-square"></i> RSS</a></div></div></div><div class="warning-zone"></div><div class="warning-zone right"></div><div class="container-mask"></div><div class="bg-canvas"><div class="loading"><img src="/img/loading.svg"><div>3D Model Loading</div></div><div class="switch-action"><label class="hvr-push"><input type="checkbox" name="rotate"> <i class="iconfont icon-rotate3d"></i></label> <label class="hvr-push"><input type="radio" value="walk" name="action"> <i class="iconfont icon-walk"></i></label> <label class="hvr-push"><input type="radio" value="idle" checked="checked" name="action"> <i class="iconfont icon-idle"></i></label> <label class="hvr-push"><input type="radio" value="push_up" name="action"> <i class="iconfont icon-push_up"></i></label></div></div><div class="main-container"><div id="content-outer"><div id="content-inner"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@10.4.0/styles/dracula.min.css"><div class="left-panel"><div class="article-menu panel"><h3>目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E9%9C%80%E6%B1%82%E7%9A%84%E8%A6%81%E7%82%B9"><span class="toc-text">历史记录需求的要点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%88%E5%AE%9A%E4%B9%89%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">1. 先定义历史记录的数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99-History-%E7%8A%B6%E6%80%81%E6%A8%A1%E5%9D%97"><span class="toc-text">2. 编写 History 状态模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99%E5%8F%AF%E4%BB%A5%E6%92%A4%E9%94%80%E6%88%96%E9%87%8D%E5%81%9A%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">3. 编写可以撤销或重做的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8"><span class="toc-text">4. 使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text">效果</span></a></li></ol></div></div><article id="post"><h1 class="title">vuex实现历史记录</h1><small class="description"><span class="date"><i class="fa fa-calendar"></i> 2021年01月25日</span> <span><i class="fa fa-inbox"></i> <a class="category-link" href="/categories/JavaScript/">JavaScript</a> </span><span><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/JavaScript/" rel="tag">JavaScript</a>, <a class="tag-link" href="/tags/Vue/" rel="tag">Vue</a>, <a class="tag-link" href="/tags/%E6%80%9D%E8%B7%AF/" rel="tag">思路</a></span></small><blockquote>本站文章除注明转载外，均为原创文章。如需转载请注明出处：<br><a href="https://kwokronny.top/202101/vuex-develop-history/">https://kwokronny.top/202101/vuex-develop-history/</a></blockquote><img src="/202101/vuex-develop-history/cover.png" class="" width="0" height="0"><p>最近自研着一个可视化操作平台，其中涉及到用户操作后可撤销或重做，在网上搜了一些解决思路，完善自己所设想的解决思路。</p><h2 id="历史记录需求的要点"><a href="#历史记录需求的要点" class="headerlink" title="历史记录需求的要点"></a>历史记录需求的要点</h2><ul><li>可存储在 localStorage 中</li><li>可多次撤销或多次重做</li><li>点击列表中的一项，将历史倒退或前进至指定位置</li></ul><p>看似简单的需求，在基础建设设计上的错误，亦会在未来导致更多的工作量。所以结合上面两点的要求，发现 vuex 的基本思路非常适合完成这个需求，redux 同样。</p><h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><blockquote><p>此项目用了 typescript 来加强代码的严谨性，方便日后维护，大家简单看个思路。</p></blockquote><h3 id="1-先定义历史记录的数据结构"><a href="#1-先定义历史记录的数据结构" class="headerlink" title="1. 先定义历史记录的数据结构"></a>1. 先定义历史记录的数据结构</h3><figure class="highlight typescript"><figcaption><span>vue.d.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> HistoryItem &#123;<br>  timestrap: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 记录时间戳</span><br>  name: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 记录名称</span><br>  redo: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 重做Mutation</span><br>  undo: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 撤销Mutation</span><br>  redoParams: <span class="hljs-built_in">any</span>[]; <span class="hljs-comment">// 重做Mutation提交参数</span><br>  undoParams: <span class="hljs-built_in">any</span>[]; <span class="hljs-comment">// 撤销Mutation提交参数</span><br>&#125;<br><br><span class="hljs-keyword">interface</span> HistoryStatus &#123;<br>  historys: HistoryItem[]; <span class="hljs-comment">// 记录history数组</span><br>  _currentHistory: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 当前节点索引</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-编写-History-状态模块"><a href="#2-编写-History-状态模块" class="headerlink" title="2. 编写 History 状态模块"></a>2. 编写 History 状态模块</h3><p>编写基础操作history状态的vuex <code>module</code>，创建记录的<code>Mutation</code>，重做和撤销的Action</p><blockquote><p>一条记录是包含对这个步骤的执行<code>redo</code>操作与撤销<code>undo</code>操作的。所以在用户点击列表其中一项时，应该是循环回退到当前项的前一项undo，或循环redo到当前项<br>所以需要增加一条空记录，方便用户点击空记录撤销最初的操作。</p><img src="/202101/vuex-develop-history/history_dialog.png" class=""><p>运用了<code>vuex-module-decorators</code> 装饰器，写更易维护的代码</p></blockquote><figure class="highlight typescript"><figcaption><span>store/modules/History.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; VuexModule, Module, Mutation, Action &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vuex-module-decorators&quot;</span>;<br><br><span class="hljs-meta">@Module</span>(&#123; <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span> &#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HistoryModule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">VuexModule</span>&lt;<span class="hljs-title">HistoryStatus</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">HistoryStatus</span> </span>&#123;<br>  <span class="hljs-comment">/** </span><br><span class="hljs-comment">   * 初始化一个空记录的原因主要是方便列表操作时：</span><br><span class="hljs-comment">   * 当用户点击最早的一条记录时，可以正常撤销用户操作的第一步</span><br><span class="hljs-comment">  **/</span><br>  <span class="hljs-keyword">public</span> historys: HistoryItem[] = [<br>    &#123;<br>      name: <span class="hljs-string">`打开`</span>,<br>      timestrap: <span class="hljs-built_in">Date</span>.now(),<br>      redo: <span class="hljs-string">&quot;&quot;</span>,<br>      redoParams: [],<br>      undo: <span class="hljs-string">&quot;&quot;</span>,<br>      undoParams: [],<br>    &#125;,<br>  ];<br>  <span class="hljs-keyword">public</span> _currentHistory: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// getter</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title">current</span>()&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._currentHistory;<br>  &#125;<br><br>  <span class="hljs-comment">// getter</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title">historyList</span>(): <span class="hljs-title">HistoryItem</span>[] &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.historys || [];<br>  &#125;<br><br>  <span class="hljs-comment">// 创建历史记录</span><br>  <span class="hljs-meta">@Mutation</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">CREATE_HISTORY</span>(<span class="hljs-params">payload: HistoryItem</span>)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._currentHistory &lt; <span class="hljs-built_in">this</span>.historys.length - <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-built_in">this</span>.historys = <span class="hljs-built_in">this</span>.historys.slice(<span class="hljs-number">0</span>, <span class="hljs-built_in">this</span>._currentHistory);<br>    &#125;<br>    <span class="hljs-comment">// 由于js的深浅拷贝问题，所以在创建时都需要对数据进行深拷贝</span><br>    <span class="hljs-comment">// 想尝试lodash的clone函数，但发现好像JSON.stringify的方式clone应该更快的，毕竟我们的数据不存在函数</span><br>    <span class="hljs-comment">// 我这里就先不改了，主要是表达出思路即可</span><br>    <span class="hljs-built_in">this</span>.historys.push(_.cloneDeep(payload));<br>    <span class="hljs-built_in">this</span>._currentHistory = <span class="hljs-built_in">this</span>.historys.length - <span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Mutation</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">SET_CURRENT_HISTORY</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>)</span> &#123;<br>    <span class="hljs-built_in">this</span>._currentHistory = index &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : index;<br>  &#125;<br><br>  <span class="hljs-comment">// 重做</span><br>  <span class="hljs-meta">@Action</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">RedoHistory</span>(<span class="hljs-params">times: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span></span>)</span> &#123;<br>    <span class="hljs-keyword">let</span> &#123; state, commit &#125; = <span class="hljs-built_in">this</span>.context;<br>    <span class="hljs-keyword">let</span> historys: HistoryItem[] = state.historys;<br>    <span class="hljs-keyword">let</span> current: <span class="hljs-built_in">number</span> = state._currentHistory;<br>    <span class="hljs-keyword">if</span> (current + times &gt;= historys.length) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">while</span> (times &gt; <span class="hljs-number">0</span>) &#123;<br>      current++;<br>      <span class="hljs-keyword">let</span> history = historys[current];<br>      <span class="hljs-keyword">if</span> (history) &#123;<br>        commit(history.redo, ...history.redoParams, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br>      &#125;<br>      times--;<br>    &#125;<br>    commit(<span class="hljs-string">&quot;SET_CURRENT_HISTORY&quot;</span>, current);<br>  &#125;<br><br>  <span class="hljs-comment">// 撤销</span><br>  <span class="hljs-meta">@Action</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">UndoHistory</span>(<span class="hljs-params">times: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span></span>)</span> &#123;<br>    <span class="hljs-keyword">let</span> &#123; state, commit &#125; = <span class="hljs-built_in">this</span>.context;<br>    <span class="hljs-keyword">let</span> historys: HistoryItem[] = state.historys;<br>    <span class="hljs-keyword">let</span> current: <span class="hljs-built_in">number</span> = state._currentHistory;<br>    <span class="hljs-keyword">if</span> (current - times &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">while</span> (times &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">let</span> history = historys[current];<br>      <span class="hljs-keyword">if</span> (history) &#123;<br>        commit(history.undo, ...history.undoParams, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br>      &#125;<br>      times--;<br>      current--;<br>    &#125;<br>    commit(<span class="hljs-string">&quot;SET_CURRENT_HISTORY&quot;</span>, current);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-编写可以撤销或重做的功能"><a href="#3-编写可以撤销或重做的功能" class="headerlink" title="3. 编写可以撤销或重做的功能"></a>3. 编写可以撤销或重做的功能</h3><p>完成上面两步后，我们就可以编写各种操作了</p><ol><li><p>编写对数据基础操作的<code>Mutation</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Mutation</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">CREATE_PAGE</span>(<span class="hljs-params">payload: &#123; page: PageItem; index: <span class="hljs-built_in">number</span> &#125;</span>)</span> &#123;<br>  <span class="hljs-built_in">this</span>.pages.splice(payload.index, <span class="hljs-number">0</span>, _.cloneDeep(payload.page));<br>  <span class="hljs-built_in">this</span>._currentPage = <span class="hljs-built_in">this</span>.pages.length - <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-meta">@Mutation</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">REMOVE_PAGE</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>)</span> &#123;<br>  <span class="hljs-keyword">let</span> index = <span class="hljs-built_in">this</span>.pages.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id == id);<br>  index &gt; -<span class="hljs-number">1</span> &amp;&amp; <span class="hljs-built_in">this</span>.pages.splice(index, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._currentPage == index) &#123;<br>    <span class="hljs-built_in">this</span>._currentPage = <span class="hljs-built_in">this</span>.pages.length &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>将基础操作按要求封装成带保存-&gt;记录-&gt;执行的<code>Action</code></p><figure class="highlight typescript"><figcaption><span>store/modules/Page.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 包装创建页面函数</span><br><span class="hljs-meta">@Action</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">CreatePage</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-string">&quot;page&quot;</span> | <span class="hljs-string">&quot;dialog&quot;</span></span>)</span> &#123;<br>  <span class="hljs-keyword">let</span> &#123; state, commit &#125; = <span class="hljs-built_in">this</span>.context;<br>  <br>  <span class="hljs-comment">// 记录保存即将创建的页面</span><br>  <span class="hljs-keyword">let</span> id = _.uniqueId(<span class="hljs-keyword">type</span>) + <span class="hljs-built_in">Date</span>.now();<br>  <span class="hljs-keyword">let</span> pageName = pageType[<span class="hljs-keyword">type</span>];<br>  <span class="hljs-keyword">let</span> page: PageItem = &#123;<br>    id,<br>    name: <span class="hljs-string">`<span class="hljs-subst">$&#123;pageName&#125;</span><span class="hljs-subst">$&#123;state.pages.length + <span class="hljs-number">1</span>&#125;</span>`</span>,<br>    <span class="hljs-keyword">type</span>,<br>    layers: [],<br>    style: &#123; <span class="hljs-attr">width</span>: <span class="hljs-number">720</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">1280</span> &#125;,<br>  &#125;;<br><br>  <span class="hljs-comment">//创建历史记录</span><br>  <span class="hljs-keyword">let</span> history: HistoryItem = &#123;<br>    name: <span class="hljs-string">`创建<span class="hljs-subst">$&#123;pageName&#125;</span>`</span>,<br>    timestrap: <span class="hljs-built_in">Date</span>.now(),<br>    redo: <span class="hljs-string">&quot;Page/CREATE_PAGE&quot;</span>,<br>    redoParams: [&#123; <span class="hljs-attr">index</span>: state.pages.length - <span class="hljs-number">1</span>, page &#125;],<br>    undo: <span class="hljs-string">&quot;Page/REMOVE_PAGE&quot;</span>,<br>    undoParams: [id],<br>  &#125;;<br>  <span class="hljs-comment">// 保存记录此历史记录</span><br>  commit(<span class="hljs-string">&quot;Histroy/CREATE_HISTORY&quot;</span>, history, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br><br>  commit(history.redo, ...history.redoParams, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight typescript"><figcaption><span>store/modules/Page.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Action</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">RemovePage</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>)</span> &#123;<br>  <span class="hljs-comment">// 记录保存现场状态</span><br>  <span class="hljs-keyword">let</span> index = <span class="hljs-built_in">this</span>.pages.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id == id);<br>  <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">let</span> page: PageItem = <span class="hljs-built_in">this</span>.context.state.pages[index];<br><br>  <span class="hljs-comment">//创建历史记录</span><br>  <span class="hljs-keyword">let</span> history: HistoryItem = &#123;<br>    name: <span class="hljs-string">`删除 <span class="hljs-subst">$&#123;page.name&#125;</span>`</span>,<br>    timestrap: <span class="hljs-built_in">Date</span>.now(),<br>    redo: <span class="hljs-string">&quot;Page/REMOVE_PAGE&quot;</span>,<br>    redoParams: [id],<br>    undo: <span class="hljs-string">&quot;Page/CREATE_PAGE&quot;</span>,<br>    undoParams: [&#123; page, index &#125;],<br>  &#125;;<br><br>  <span class="hljs-comment">// 保存记录此历史记录</span><br>  <span class="hljs-built_in">this</span>.context.commit(<span class="hljs-string">&quot;Histroy/CREATE_HISTORY&quot;</span>, history, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br>  <span class="hljs-built_in">this</span>.context.commit(history.redo, ...history.redoParams, &#123; <span class="hljs-attr">root</span>: <span class="hljs-literal">true</span> &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>以上，撤销与重做的功能就基本完成了</p><h3 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h3><ol><li>我们现在只需要在使用时创建或删除页面时使用封装的<code>Action</code>后</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-string">&quot;page&quot;</span> | <span class="hljs-string">&quot;dialog&quot;</span></span>)</span> &#123;<br>  <span class="hljs-built_in">this</span>.$store.dispatch(<span class="hljs-string">&quot;Page/CreatePage&quot;</span>, <span class="hljs-keyword">type</span>);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-title">remove</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>)</span> &#123;<br>  <span class="hljs-built_in">this</span>.$store.dispatch(<span class="hljs-string">&quot;Page/RemovePage&quot;</span>, id);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>配置全局热键</li></ol><figure class="highlight typescript"><figcaption><span>App.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript">...<br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-title">mounted</span>(<span class="hljs-params"></span>)</span> &#123;<br>  <span class="hljs-keyword">let</span> self = <span class="hljs-built_in">this</span>;<br>  hotkeys(<span class="hljs-string">&quot;ctrl+z&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, handler</span>) </span>&#123;<br>    self.$store.dispatch(<span class="hljs-string">&quot;History/UndoHistory&quot;</span>);<br>  &#125;);<br>  hotkeys(<span class="hljs-string">&quot;ctrl+y&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, handler</span>) </span>&#123;<br>    self.$store.dispatch(<span class="hljs-string">&quot;History/RedoHistory&quot;</span>);<br>  &#125;);<br>&#125;<br>...<br></code></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><img src="/202101/vuex-develop-history/effect.gif" class=""></li></ol><div class="donate-panel"><label><input type="checkbox"><i class="fa fa-qrcode"></i> 打赏</label> 如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!<div class="donate-code"><img src="/img/wechat_pay.jpg"> <img src="/img/alipay.jpg"></div></div><script type="text/javascript">document.querySelector(".donate-panel input").addEventListener("change",function(){document.querySelector(".donate-code").classList.toggle("show")})</script><script src="https://utteranc.es/client.js" repo="kwokronny/kwokronny.github.io" issue-term="9d45821f667f36e222adce49e18fb281" theme="github-dark" crossorigin="anonymous" async></script></article></div></div></div><div class="footer">Power by <a target="_blank" rel="noopener" href="http://hexo.io">hexo</a>. | 3D Model Thx SketchFab: <a target="_blank" rel="noopener" href="https://sketchfab.com/Blender3D">Blender3D</a>, <a target="_blank" rel="noopener" href="https://sketchfab.com/arexon">Arexon</a></div><script src="/js/three/three.min.js"></script><script src="/js/three/GLTFLoader.min.js"></script><script src="/js/three/OrbitControls.min.js"></script><script src="/js/index.js"></script><script src="/js/minecraft.js"></script></body></html>